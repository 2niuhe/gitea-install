# Gitea 存储挂载详解

## 📋 概述

本文档详细说明了 Gitea Docker 容器的存储挂载方式、数据结构和最佳实践。

## 🏗️ 存储架构

### 容器内数据结构

Gitea 容器内的数据统一存储在 `/data` 目录下：

```
/data/
├── git/                        # Git 仓库数据
│   └── repositories/           # 所有 Git 仓库
│       ├── user1/repo1.git/
│       ├── user2/repo2.git/
│       └── ...
├── gitea/                      # Gitea 应用数据
│   ├── conf/
│   │   └── app.ini            # 主配置文件
│   ├── gitea.db               # SQLite 数据库文件
│   ├── log/                   # 日志文件
│   │   ├── gitea.log
│   │   ├── ssh.log
│   │   └── xorm.log
│   ├── sessions/              # 会话文件
│   └── tmp/                   # 临时文件
├── ssh/                       # SSH 相关文件
│   ├── ssh_host_rsa_key       # RSA 私钥
│   ├── ssh_host_rsa_key.pub   # RSA 公钥
│   ├── ssh_host_ecdsa_key     # ECDSA 私钥
│   ├── ssh_host_ecdsa_key.pub # ECDSA 公钥
│   └── ssh_host_ed25519_key   # Ed25519 私钥
└── home/                      # 用户家目录 (可选)
    └── gitea/
```

## 🔗 挂载方式对比

### 方式1: Docker 卷挂载 (推荐)

#### 配置示例
```yaml
version: '3.8'

services:
  gitea:
    image: gitea/gitea:latest
    volumes:
      - gitea_data:/data

volumes:
  gitea_data:
    driver: local
```

#### 优点
- ✅ **自动管理**: Docker 自动管理存储位置和权限
- ✅ **数据安全**: 容器删除后数据依然保留
- ✅ **迁移友好**: 备份和迁移相对简单
- ✅ **权限自动**: Docker 自动设置合适的权限
- ✅ **跨平台**: 在不同操作系统上表现一致

#### 缺点
- ❌ **位置不透明**: 数据存储位置由 Docker 管理
- ❌ **访问限制**: 不能直接从主机访问文件

#### 数据位置
```bash
# 查看 Docker 卷的实际位置
docker volume inspect gitea_gitea_data

# 通常位于
/var/lib/docker/volumes/gitea_gitea_data/_data/
```

### 方式2: 主机目录挂载

#### 配置示例
```yaml
version: '3.8'

services:
  gitea:
    image: gitea/gitea:latest
    volumes:
      - ./gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
```

#### 优点
- ✅ **直接访问**: 可以直接从主机访问所有文件
- ✅ **位置明确**: 数据存储位置完全可控
- ✅ **备份简单**: 可以使用标准文件系统工具备份
- ✅ **权限灵活**: 可以精确控制文件权限

#### 缺点
- ❌ **权限问题**: 需要手动处理文件权限
- ❌ **路径依赖**: 迁移时需要保持路径结构
- ❌ **平台差异**: 不同操作系统的路径处理不同

#### 权限设置
```bash
# 设置目录权限
sudo chown -R 1000:1000 ./gitea-data
sudo chmod -R 755 ./gitea-data
```

### 方式3: 混合挂载 (高级)

#### 配置示例
```yaml
version: '3.8'

services:
  gitea:
    image: gitea/gitea:latest
    volumes:
      - gitea_app_data:/data/gitea      # 应用数据用 Docker 卷
      - gitea_repos:/data/git           # 仓库数据用 Docker 卷
      - ./gitea-config:/data/gitea/conf # 配置文件用主机目录
      - ./backups:/backups              # 备份目录用主机目录
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

volumes:
  gitea_app_data:
    driver: local
  gitea_repos:
    driver: local
```

## 🗄️ 数据库存储选项

### SQLite (默认)
```yaml
environment:
  - GITEA__database__DB_TYPE=sqlite3
  - GITEA__database__PATH=/data/gitea/gitea.db
```

**特点**:
- ✅ 简单易用，无需额外配置
- ✅ 数据存储在文件中
- ❌ 并发性能有限
- ❌ 不适合大规模部署

### PostgreSQL (推荐生产环境)
```yaml
services:
  gitea:
    environment:
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=gitea-db
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea-password

  gitea-db:
    image: postgres:13
    environment:
      - POSTGRES_DB=gitea
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=gitea-password
    volumes:
      - gitea_db_data:/var/lib/postgresql/data

volumes:
  gitea_db_data:
    driver: local
```

### MySQL
```yaml
services:
  gitea:
    environment:
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=gitea-db
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea-password

  gitea-db:
    image: mysql:8
    environment:
      - MYSQL_DATABASE=gitea
      - MYSQL_USER=gitea
      - MYSQL_PASSWORD=gitea-password
      - MYSQL_ROOT_PASSWORD=root-password
    volumes:
      - gitea_db_data:/var/lib/mysql

volumes:
  gitea_db_data:
    driver: local
```

## 📊 存储容量规划

### 存储需求评估

#### 基础存储需求
- **系统文件**: ~500MB
- **数据库**: 起始 ~50MB，根据使用量增长
- **日志文件**: 起始 ~10MB，需要定期清理
- **临时文件**: ~100MB

#### 仓库存储需求
```
估算公式: 仓库数量 × 平均仓库大小 × 1.5 (历史版本)

示例:
- 100个仓库，平均 100MB → 100 × 100MB × 1.5 = 15GB
- 1000个仓库，平均 500MB → 1000 × 500MB × 1.5 = 750GB
```

#### 存储规划建议
```yaml
# 小型团队 (< 10个仓库)
- 最小: 10GB
- 推荐: 50GB

# 中型团队 (10-100个仓库)
- 最小: 100GB
- 推荐: 500GB

# 大型团队 (100+个仓库)
- 最小: 1TB
- 推荐: 5TB+
```

## 🔧 存储优化

### 1. 日志管理
```yaml
environment:
  - GITEA__log__ROOT_PATH=/data/gitea/log
  - GITEA__log__MODE=file
  - GITEA__log__LEVEL=Info
  - GITEA__log__ENABLE_SSH_LOG=false
  - GITEA__log__ENABLE_XORM_LOG=false
```

### 2. 附件存储
```yaml
environment:
  - GITEA__attachment__PATH=/data/gitea/attachments
  - GITEA__attachment__MAX_SIZE=4
  - GITEA__attachment__ENABLED=true
```

### 3. LFS (Large File Storage)
```yaml
environment:
  - GITEA__lfs__STORAGE_TYPE=local
  - GITEA__lfs__PATH=/data/gitea/lfs
  - GITEA__lfs__ENABLED=true
```

## 🔄 备份策略

### 自动备份脚本
```bash
#!/bin/bash
# backup-storage.sh

BACKUP_DIR="/backup/gitea"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/gitea_backup_$DATE.tar.gz"

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 停止服务
docker-compose down

# 备份 Docker 卷
docker run --rm \
    -v gitea_gitea_data:/data \
    -v "$BACKUP_DIR":/backup \
    alpine tar czf "/backup/gitea_data_$DATE.tar.gz" -C /data .

# 如果使用主机目录挂载
# tar czf "$BACKUP_FILE" ./gitea-data/

# 启动服务
docker-compose up -d

# 清理旧备份 (保留30天)
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

echo "备份完成: $BACKUP_FILE"
```

### 增量备份方案
```bash
#!/bin/bash
# incremental-backup.sh

SOURCE_DIR="/var/lib/docker/volumes/gitea_gitea_data/_data"
BACKUP_DIR="/backup/gitea/incremental"
LAST_BACKUP_FILE="$BACKUP_DIR/last_backup.txt"

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 获取上次备份时间
if [ -f "$LAST_BACKUP_FILE" ]; then
    LAST_BACKUP=$(cat "$LAST_BACKUP_FILE")
else
    LAST_BACKUP="1970-01-01 00:00:00"
fi

# 增量备份
DATE=$(date +%Y%m%d_%H%M%S)
docker run --rm \
    -v gitea_gitea_data:/data \
    -v "$BACKUP_DIR":/backup \
    alpine tar czf "/backup/incremental_$DATE.tar.gz" \
    --newer-mtime "$LAST_BACKUP" -C /data .

# 更新备份时间
date "+%Y-%m-%d %H:%M:%S" > "$LAST_BACKUP_FILE"
```

## 🔒 安全考虑

### 1. 文件权限
```bash
# 设置正确的文件权限
sudo chown -R 1000:1000 /path/to/gitea-data
sudo chmod -R 755 /path/to/gitea-data
sudo chmod 600 /path/to/gitea-data/gitea/gitea.db
```

### 2. 敏感文件保护
```bash
# 保护 SSH 密钥
chmod 600 /path/to/gitea-data/ssh/ssh_host_*_key
chmod 644 /path/to/gitea-data/ssh/ssh_host_*_key.pub

# 保护配置文件
chmod 644 /path/to/gitea-data/gitea/conf/app.ini
```

### 3. SELinux/AppArmor 配置
```bash
# SELinux (如果启用)
sudo semanage fcontext -a -t container_file_t "/path/to/gitea-data(/.*)?"
sudo restorecon -R /path/to/gitea-data
```

## 📈 性能优化

### 1. 存储类型选择
- **SSD**: 推荐用于生产环境，提高读写性能
- **NVMe**: 高性能需求场景
- **网络存储**: 适用于集群部署

### 2. I/O 优化
```yaml
# 使用 tmpfs 提升临时文件性能
volumes:
  - gitea_tmp:/tmp

# 或者挂载主机 tmpfs
volumes:
  - /tmp:/tmp
```

### 3. 数据库优化
```yaml
# SQLite 优化
environment:
  - GITEA__database__SQLITE_JOURNAL_MODE=WAL
  - GITEA__database__SQLITE_CACHE=2000
  - GITEA__database__SQLITE_TIMEOUT=5000
```

## 🛠️ 故障排除

### 1. 权限问题
```bash
# 修复权限问题
docker run --rm \
    -v gitea_gitea_data:/data \
    alpine chown -R 1000:1000 /data

# 检查当前权限
docker run --rm \
    -v gitea_gitea_data:/data \
    alpine ls -la /data
```

### 2. 磁盘空间不足
```bash
# 检查磁盘使用情况
docker system df

# 清理未使用的资源
docker system prune -a

# 查看卷使用情况
docker run --rm \
    -v gitea_gitea_data:/data \
    alpine du -sh /data/*
```

### 3. 数据损坏检查
```bash
# 检查 SQLite 数据库
docker exec gitea sqlite3 /data/gitea/gitea.db "PRAGMA integrity_check;"

# 检查 Git 仓库
docker exec gitea find /data/git/repositories -name "*.git" -exec git --git-dir={} fsck \;
```

## 📝 最佳实践总结

1. **使用 Docker 卷挂载** - 简化管理，提高可靠性
2. **定期备份** - 制定完整的备份策略
3. **监控存储使用** - 及时扩容避免服务中断
4. **权限管理** - 确保文件权限正确设置
5. **日志轮转** - 防止日志文件占用过多空间
6. **性能优化** - 根据需求选择合适的存储类型
7. **安全加固** - 保护敏感文件和配置

通过遵循这些最佳实践，可以确保 Gitea 存储系统的稳定性、安全性和性能。
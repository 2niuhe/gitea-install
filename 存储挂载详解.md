# Gitea å­˜å‚¨æŒ‚è½½è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† Gitea Docker å®¹å™¨çš„å­˜å‚¨æŒ‚è½½æ–¹å¼ã€æ•°æ®ç»“æ„å’Œæœ€ä½³å®è·µã€‚

## ğŸ—ï¸ å­˜å‚¨æ¶æ„

### å®¹å™¨å†…æ•°æ®ç»“æ„

Gitea å®¹å™¨å†…çš„æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨ `/data` ç›®å½•ä¸‹ï¼š

```
/data/
â”œâ”€â”€ git/                        # Git ä»“åº“æ•°æ®
â”‚   â””â”€â”€ repositories/           # æ‰€æœ‰ Git ä»“åº“
â”‚       â”œâ”€â”€ user1/repo1.git/
â”‚       â”œâ”€â”€ user2/repo2.git/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ gitea/                      # Gitea åº”ç”¨æ•°æ®
â”‚   â”œâ”€â”€ conf/
â”‚   â”‚   â””â”€â”€ app.ini            # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ gitea.db               # SQLite æ•°æ®åº“æ–‡ä»¶
â”‚   â”œâ”€â”€ log/                   # æ—¥å¿—æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ gitea.log
â”‚   â”‚   â”œâ”€â”€ ssh.log
â”‚   â”‚   â””â”€â”€ xorm.log
â”‚   â”œâ”€â”€ sessions/              # ä¼šè¯æ–‡ä»¶
â”‚   â””â”€â”€ tmp/                   # ä¸´æ—¶æ–‡ä»¶
â”œâ”€â”€ ssh/                       # SSH ç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ ssh_host_rsa_key       # RSA ç§é’¥
â”‚   â”œâ”€â”€ ssh_host_rsa_key.pub   # RSA å…¬é’¥
â”‚   â”œâ”€â”€ ssh_host_ecdsa_key     # ECDSA ç§é’¥
â”‚   â”œâ”€â”€ ssh_host_ecdsa_key.pub # ECDSA å…¬é’¥
â”‚   â””â”€â”€ ssh_host_ed25519_key   # Ed25519 ç§é’¥
â””â”€â”€ home/                      # ç”¨æˆ·å®¶ç›®å½• (å¯é€‰)
    â””â”€â”€ gitea/
```

## ğŸ”— æŒ‚è½½æ–¹å¼å¯¹æ¯”

### æ–¹å¼1: Docker å·æŒ‚è½½ (æ¨è)

#### é…ç½®ç¤ºä¾‹
```yaml
version: '3.8'

services:
  gitea:
    image: gitea/gitea:latest
    volumes:
      - gitea_data:/data

volumes:
  gitea_data:
    driver: local
```

#### ä¼˜ç‚¹
- âœ… **è‡ªåŠ¨ç®¡ç†**: Docker è‡ªåŠ¨ç®¡ç†å­˜å‚¨ä½ç½®å’Œæƒé™
- âœ… **æ•°æ®å®‰å…¨**: å®¹å™¨åˆ é™¤åæ•°æ®ä¾ç„¶ä¿ç•™
- âœ… **è¿ç§»å‹å¥½**: å¤‡ä»½å’Œè¿ç§»ç›¸å¯¹ç®€å•
- âœ… **æƒé™è‡ªåŠ¨**: Docker è‡ªåŠ¨è®¾ç½®åˆé€‚çš„æƒé™
- âœ… **è·¨å¹³å°**: åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šè¡¨ç°ä¸€è‡´

#### ç¼ºç‚¹
- âŒ **ä½ç½®ä¸é€æ˜**: æ•°æ®å­˜å‚¨ä½ç½®ç”± Docker ç®¡ç†
- âŒ **è®¿é—®é™åˆ¶**: ä¸èƒ½ç›´æ¥ä»ä¸»æœºè®¿é—®æ–‡ä»¶

#### æ•°æ®ä½ç½®
```bash
# æŸ¥çœ‹ Docker å·çš„å®é™…ä½ç½®
docker volume inspect gitea_gitea_data

# é€šå¸¸ä½äº
/var/lib/docker/volumes/gitea_gitea_data/_data/
```

### æ–¹å¼2: ä¸»æœºç›®å½•æŒ‚è½½

#### é…ç½®ç¤ºä¾‹
```yaml
version: '3.8'

services:
  gitea:
    image: gitea/gitea:latest
    volumes:
      - ./gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
```

#### ä¼˜ç‚¹
- âœ… **ç›´æ¥è®¿é—®**: å¯ä»¥ç›´æ¥ä»ä¸»æœºè®¿é—®æ‰€æœ‰æ–‡ä»¶
- âœ… **ä½ç½®æ˜ç¡®**: æ•°æ®å­˜å‚¨ä½ç½®å®Œå…¨å¯æ§
- âœ… **å¤‡ä»½ç®€å•**: å¯ä»¥ä½¿ç”¨æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿå·¥å…·å¤‡ä»½
- âœ… **æƒé™çµæ´»**: å¯ä»¥ç²¾ç¡®æ§åˆ¶æ–‡ä»¶æƒé™

#### ç¼ºç‚¹
- âŒ **æƒé™é—®é¢˜**: éœ€è¦æ‰‹åŠ¨å¤„ç†æ–‡ä»¶æƒé™
- âŒ **è·¯å¾„ä¾èµ–**: è¿ç§»æ—¶éœ€è¦ä¿æŒè·¯å¾„ç»“æ„
- âŒ **å¹³å°å·®å¼‚**: ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„å¤„ç†ä¸åŒ

#### æƒé™è®¾ç½®
```bash
# è®¾ç½®ç›®å½•æƒé™
sudo chown -R 1000:1000 ./gitea-data
sudo chmod -R 755 ./gitea-data
```

### æ–¹å¼3: æ··åˆæŒ‚è½½ (é«˜çº§)

#### é…ç½®ç¤ºä¾‹
```yaml
version: '3.8'

services:
  gitea:
    image: gitea/gitea:latest
    volumes:
      - gitea_app_data:/data/gitea      # åº”ç”¨æ•°æ®ç”¨ Docker å·
      - gitea_repos:/data/git           # ä»“åº“æ•°æ®ç”¨ Docker å·
      - ./gitea-config:/data/gitea/conf # é…ç½®æ–‡ä»¶ç”¨ä¸»æœºç›®å½•
      - ./backups:/backups              # å¤‡ä»½ç›®å½•ç”¨ä¸»æœºç›®å½•
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

volumes:
  gitea_app_data:
    driver: local
  gitea_repos:
    driver: local
```

## ğŸ—„ï¸ æ•°æ®åº“å­˜å‚¨é€‰é¡¹

### SQLite (é»˜è®¤)
```yaml
environment:
  - GITEA__database__DB_TYPE=sqlite3
  - GITEA__database__PATH=/data/gitea/gitea.db
```

**ç‰¹ç‚¹**:
- âœ… ç®€å•æ˜“ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
- âœ… æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ä¸­
- âŒ å¹¶å‘æ€§èƒ½æœ‰é™
- âŒ ä¸é€‚åˆå¤§è§„æ¨¡éƒ¨ç½²

### PostgreSQL (æ¨èç”Ÿäº§ç¯å¢ƒ)
```yaml
services:
  gitea:
    environment:
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=gitea-db
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea-password

  gitea-db:
    image: postgres:13
    environment:
      - POSTGRES_DB=gitea
      - POSTGRES_USER=gitea
      - POSTGRES_PASSWORD=gitea-password
    volumes:
      - gitea_db_data:/var/lib/postgresql/data

volumes:
  gitea_db_data:
    driver: local
```

### MySQL
```yaml
services:
  gitea:
    environment:
      - GITEA__database__DB_TYPE=mysql
      - GITEA__database__HOST=gitea-db
      - GITEA__database__NAME=gitea
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea-password

  gitea-db:
    image: mysql:8
    environment:
      - MYSQL_DATABASE=gitea
      - MYSQL_USER=gitea
      - MYSQL_PASSWORD=gitea-password
      - MYSQL_ROOT_PASSWORD=root-password
    volumes:
      - gitea_db_data:/var/lib/mysql

volumes:
  gitea_db_data:
    driver: local
```

## ğŸ“Š å­˜å‚¨å®¹é‡è§„åˆ’

### å­˜å‚¨éœ€æ±‚è¯„ä¼°

#### åŸºç¡€å­˜å‚¨éœ€æ±‚
- **ç³»ç»Ÿæ–‡ä»¶**: ~500MB
- **æ•°æ®åº“**: èµ·å§‹ ~50MBï¼Œæ ¹æ®ä½¿ç”¨é‡å¢é•¿
- **æ—¥å¿—æ–‡ä»¶**: èµ·å§‹ ~10MBï¼Œéœ€è¦å®šæœŸæ¸…ç†
- **ä¸´æ—¶æ–‡ä»¶**: ~100MB

#### ä»“åº“å­˜å‚¨éœ€æ±‚
```
ä¼°ç®—å…¬å¼: ä»“åº“æ•°é‡ Ã— å¹³å‡ä»“åº“å¤§å° Ã— 1.5 (å†å²ç‰ˆæœ¬)

ç¤ºä¾‹:
- 100ä¸ªä»“åº“ï¼Œå¹³å‡ 100MB â†’ 100 Ã— 100MB Ã— 1.5 = 15GB
- 1000ä¸ªä»“åº“ï¼Œå¹³å‡ 500MB â†’ 1000 Ã— 500MB Ã— 1.5 = 750GB
```

#### å­˜å‚¨è§„åˆ’å»ºè®®
```yaml
# å°å‹å›¢é˜Ÿ (< 10ä¸ªä»“åº“)
- æœ€å°: 10GB
- æ¨è: 50GB

# ä¸­å‹å›¢é˜Ÿ (10-100ä¸ªä»“åº“)
- æœ€å°: 100GB
- æ¨è: 500GB

# å¤§å‹å›¢é˜Ÿ (100+ä¸ªä»“åº“)
- æœ€å°: 1TB
- æ¨è: 5TB+
```

## ğŸ”§ å­˜å‚¨ä¼˜åŒ–

### 1. æ—¥å¿—ç®¡ç†
```yaml
environment:
  - GITEA__log__ROOT_PATH=/data/gitea/log
  - GITEA__log__MODE=file
  - GITEA__log__LEVEL=Info
  - GITEA__log__ENABLE_SSH_LOG=false
  - GITEA__log__ENABLE_XORM_LOG=false
```

### 2. é™„ä»¶å­˜å‚¨
```yaml
environment:
  - GITEA__attachment__PATH=/data/gitea/attachments
  - GITEA__attachment__MAX_SIZE=4
  - GITEA__attachment__ENABLED=true
```

### 3. LFS (Large File Storage)
```yaml
environment:
  - GITEA__lfs__STORAGE_TYPE=local
  - GITEA__lfs__PATH=/data/gitea/lfs
  - GITEA__lfs__ENABLED=true
```

## ğŸ”„ å¤‡ä»½ç­–ç•¥

### è‡ªåŠ¨å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup-storage.sh

BACKUP_DIR="/backup/gitea"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/gitea_backup_$DATE.tar.gz"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# åœæ­¢æœåŠ¡
docker-compose down

# å¤‡ä»½ Docker å·
docker run --rm \
    -v gitea_gitea_data:/data \
    -v "$BACKUP_DIR":/backup \
    alpine tar czf "/backup/gitea_data_$DATE.tar.gz" -C /data .

# å¦‚æœä½¿ç”¨ä¸»æœºç›®å½•æŒ‚è½½
# tar czf "$BACKUP_FILE" ./gitea-data/

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æ¸…ç†æ—§å¤‡ä»½ (ä¿ç•™30å¤©)
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_FILE"
```

### å¢é‡å¤‡ä»½æ–¹æ¡ˆ
```bash
#!/bin/bash
# incremental-backup.sh

SOURCE_DIR="/var/lib/docker/volumes/gitea_gitea_data/_data"
BACKUP_DIR="/backup/gitea/incremental"
LAST_BACKUP_FILE="$BACKUP_DIR/last_backup.txt"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# è·å–ä¸Šæ¬¡å¤‡ä»½æ—¶é—´
if [ -f "$LAST_BACKUP_FILE" ]; then
    LAST_BACKUP=$(cat "$LAST_BACKUP_FILE")
else
    LAST_BACKUP="1970-01-01 00:00:00"
fi

# å¢é‡å¤‡ä»½
DATE=$(date +%Y%m%d_%H%M%S)
docker run --rm \
    -v gitea_gitea_data:/data \
    -v "$BACKUP_DIR":/backup \
    alpine tar czf "/backup/incremental_$DATE.tar.gz" \
    --newer-mtime "$LAST_BACKUP" -C /data .

# æ›´æ–°å¤‡ä»½æ—¶é—´
date "+%Y-%m-%d %H:%M:%S" > "$LAST_BACKUP_FILE"
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. æ–‡ä»¶æƒé™
```bash
# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
sudo chown -R 1000:1000 /path/to/gitea-data
sudo chmod -R 755 /path/to/gitea-data
sudo chmod 600 /path/to/gitea-data/gitea/gitea.db
```

### 2. æ•æ„Ÿæ–‡ä»¶ä¿æŠ¤
```bash
# ä¿æŠ¤ SSH å¯†é’¥
chmod 600 /path/to/gitea-data/ssh/ssh_host_*_key
chmod 644 /path/to/gitea-data/ssh/ssh_host_*_key.pub

# ä¿æŠ¤é…ç½®æ–‡ä»¶
chmod 644 /path/to/gitea-data/gitea/conf/app.ini
```

### 3. SELinux/AppArmor é…ç½®
```bash
# SELinux (å¦‚æœå¯ç”¨)
sudo semanage fcontext -a -t container_file_t "/path/to/gitea-data(/.*)?"
sudo restorecon -R /path/to/gitea-data
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å­˜å‚¨ç±»å‹é€‰æ‹©
- **SSD**: æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæé«˜è¯»å†™æ€§èƒ½
- **NVMe**: é«˜æ€§èƒ½éœ€æ±‚åœºæ™¯
- **ç½‘ç»œå­˜å‚¨**: é€‚ç”¨äºé›†ç¾¤éƒ¨ç½²

### 2. I/O ä¼˜åŒ–
```yaml
# ä½¿ç”¨ tmpfs æå‡ä¸´æ—¶æ–‡ä»¶æ€§èƒ½
volumes:
  - gitea_tmp:/tmp

# æˆ–è€…æŒ‚è½½ä¸»æœº tmpfs
volumes:
  - /tmp:/tmp
```

### 3. æ•°æ®åº“ä¼˜åŒ–
```yaml
# SQLite ä¼˜åŒ–
environment:
  - GITEA__database__SQLITE_JOURNAL_MODE=WAL
  - GITEA__database__SQLITE_CACHE=2000
  - GITEA__database__SQLITE_TIMEOUT=5000
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. æƒé™é—®é¢˜
```bash
# ä¿®å¤æƒé™é—®é¢˜
docker run --rm \
    -v gitea_gitea_data:/data \
    alpine chown -R 1000:1000 /data

# æ£€æŸ¥å½“å‰æƒé™
docker run --rm \
    -v gitea_gitea_data:/data \
    alpine ls -la /data
```

### 2. ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
docker system df

# æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
docker system prune -a

# æŸ¥çœ‹å·ä½¿ç”¨æƒ…å†µ
docker run --rm \
    -v gitea_gitea_data:/data \
    alpine du -sh /data/*
```

### 3. æ•°æ®æŸåæ£€æŸ¥
```bash
# æ£€æŸ¥ SQLite æ•°æ®åº“
docker exec gitea sqlite3 /data/gitea/gitea.db "PRAGMA integrity_check;"

# æ£€æŸ¥ Git ä»“åº“
docker exec gitea find /data/git/repositories -name "*.git" -exec git --git-dir={} fsck \;
```

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

1. **ä½¿ç”¨ Docker å·æŒ‚è½½** - ç®€åŒ–ç®¡ç†ï¼Œæé«˜å¯é æ€§
2. **å®šæœŸå¤‡ä»½** - åˆ¶å®šå®Œæ•´çš„å¤‡ä»½ç­–ç•¥
3. **ç›‘æ§å­˜å‚¨ä½¿ç”¨** - åŠæ—¶æ‰©å®¹é¿å…æœåŠ¡ä¸­æ–­
4. **æƒé™ç®¡ç†** - ç¡®ä¿æ–‡ä»¶æƒé™æ­£ç¡®è®¾ç½®
5. **æ—¥å¿—è½®è½¬** - é˜²æ­¢æ—¥å¿—æ–‡ä»¶å ç”¨è¿‡å¤šç©ºé—´
6. **æ€§èƒ½ä¼˜åŒ–** - æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„å­˜å‚¨ç±»å‹
7. **å®‰å…¨åŠ å›º** - ä¿æŠ¤æ•æ„Ÿæ–‡ä»¶å’Œé…ç½®

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼Œå¯ä»¥ç¡®ä¿ Gitea å­˜å‚¨ç³»ç»Ÿçš„ç¨³å®šæ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚